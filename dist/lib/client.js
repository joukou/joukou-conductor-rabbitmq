var Q, RabbitMQClient, amqplib, uuid;

amqplib = require('amqplib');

Q = require('q');

uuid = require('node-uuid');

RabbitMQClient = (function() {
  RabbitMQClient.prototype._channelDeferred = null;

  RabbitMQClient.prototype.connection = null;

  RabbitMQClient.prototype.channel = null;

  RabbitMQClient.prototype.key = null;

  RabbitMQClient.prototype.exchange = null;

  RabbitMQClient.prototype.consumer = null;

  RabbitMQClient.prototype.on = {
    connection: null,
    channel: null
  };

  function RabbitMQClient(exchange, key) {
    this.exchange = exchange;
    this.key = key;
    this._channelDeferred = Q.defer();
    this.on = {
      connection: amqplib.connect(exchange),
      channel: this._channelDeferred.promise
    };
    this._setupConnection();
  }

  RabbitMQClient.prototype._setupConnection = function() {
    var client;
    client = this;
    return this.on.connection.then(function() {
      return client._onConnection.apply(client, arguments);
    }).fail(function(err) {
      this._channelDeferred.reject(err);
    });
  };

  RabbitMQClient.prototype._onConnection = function(connection) {
    this.connection = connection;
    return this._setupChannel();
  };

  RabbitMQClient.prototype._setupChannel = function() {
    var client, ok;
    client = this;
    ok = this.connection.createChannel();
    return ok.then(function() {
      client._onChannel.apply(client, arguments);
    }).fail(function(err) {
      this._channelDeferred.reject(err);
    });
  };

  RabbitMQClient.prototype._onChannel = function(channel) {
    this.channel = channel;
    return this._channelDeferred.resolve(this);
  };

  RabbitMQClient.prototype.cancel = function(consumerTag) {
    if (!this.channel) {
      return Q.reject(new Error("Not connected"));
    }
    return this.channel.cancel(consumerTag);
  };

  RabbitMQClient.prototype.consume = function(callback, contentOnly, consumerTag) {
    var client;
    if (!(callback instanceof Function)) {
      throw new TypeError("Callback is expected to be a Function");
    }
    if (!consumerTag) {
      consumerTag = uuid.v4();
    }
    client = this;
    this.on.channel.then(function() {
      client.channel.assertQueue(client.key);
      return client.channel.consume(client.key, function(message) {
        if (message === null || message === void 0) {
          return;
        }
        if (contentOnly) {
          message = message.content;
        }
        if (message === null || message === void 0) {
          return;
        }
        return callback(null, message);
      }, {
        consumerTag: consumerTag
      });
    }).fail(function(err) {
      callback(err, null);
    });
    return consumerTag;
  };

  RabbitMQClient.prototype.send = function(message) {
    var client;
    if (!(message instanceof Buffer)) {
      message = new Buffer(message);
    }
    client = this;
    return this.on.channel.then(function() {
      client.channel.assertQueue(client.key);
      return client.channel.sendToQueue(client.key, message);
    });
  };

  return RabbitMQClient;

})();

module.exports = {
  getClient: function(exchange, key) {
    return new RabbitMQClient(exchange, key);
  },
  RabbitMQClient: RabbitMQClient
};

//# sourceMappingURL=data:application/json;base64,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anMiLCJzb3VyY2VSb290IjoiL3NvdXJjZS8iLCJzb3VyY2VzQ29udGVudCI6WyJhbXFwbGliID0gcmVxdWlyZSgnYW1xcGxpYicpXG5RICAgICAgID0gcmVxdWlyZSgncScpXG51dWlkICAgID0gcmVxdWlyZSgnbm9kZS11dWlkJylcblxuY2xhc3MgUmFiYml0TVFDbGllbnRcbiAgX2NoYW5uZWxEZWZlcnJlZDogbnVsbFxuICBjb25uZWN0aW9uOiBudWxsXG4gIGNoYW5uZWw6IG51bGxcbiAga2V5OiBudWxsXG4gIGV4Y2hhbmdlOiBudWxsXG4gIGNvbnN1bWVyOiBudWxsXG4gIG9uOlxuICAgIGNvbm5lY3Rpb246IG51bGxcbiAgICBjaGFubmVsOiBudWxsXG4gIGNvbnN0cnVjdG9yOiAoZXhjaGFuZ2UsIGtleSkgLT5cbiAgICB0aGlzLmV4Y2hhbmdlID0gZXhjaGFuZ2VcbiAgICB0aGlzLmtleSA9IGtleVxuICAgIHRoaXMuX2NoYW5uZWxEZWZlcnJlZCA9IFEuZGVmZXIoKVxuICAgIHRoaXMub24gPVxuICAgICAgY29ubmVjdGlvbjogYW1xcGxpYi5jb25uZWN0KGV4Y2hhbmdlKVxuICAgICAgY2hhbm5lbDogdGhpcy5fY2hhbm5lbERlZmVycmVkLnByb21pc2VcbiAgICB0aGlzLl9zZXR1cENvbm5lY3Rpb24oKVxuICBfc2V0dXBDb25uZWN0aW9uOiAtPlxuICAgIGNsaWVudCA9IHRoaXNcbiAgICB0aGlzLm9uLmNvbm5lY3Rpb24udGhlbiggLT5cbiAgICAgIGNsaWVudC5fb25Db25uZWN0aW9uLmFwcGx5KGNsaWVudCwgYXJndW1lbnRzKVxuICAgICkuZmFpbCggKGVycikgLT5cbiAgICAgIHRoaXMuX2NoYW5uZWxEZWZlcnJlZC5yZWplY3QoZXJyKVxuICAgICAgcmV0dXJuXG4gICAgKVxuICBfb25Db25uZWN0aW9uOiAoY29ubmVjdGlvbikgLT5cbiAgICB0aGlzLmNvbm5lY3Rpb24gPSBjb25uZWN0aW9uXG4gICAgdGhpcy5fc2V0dXBDaGFubmVsKClcbiAgX3NldHVwQ2hhbm5lbDogLT5cbiAgICBjbGllbnQgPSB0aGlzXG4gICAgb2sgPSB0aGlzLmNvbm5lY3Rpb24uY3JlYXRlQ2hhbm5lbCgpXG4gICAgb2sudGhlbiggLT5cbiAgICAgIGNsaWVudC5fb25DaGFubmVsLmFwcGx5KGNsaWVudCwgYXJndW1lbnRzKVxuICAgICAgcmV0dXJuXG4gICAgKS5mYWlsKCAoZXJyKSAtPlxuICAgICAgdGhpcy5fY2hhbm5lbERlZmVycmVkLnJlamVjdChlcnIpXG4gICAgICByZXR1cm5cbiAgICApXG4gIF9vbkNoYW5uZWw6IChjaGFubmVsKSAtPlxuICAgIHRoaXMuY2hhbm5lbCA9IGNoYW5uZWxcbiAgICB0aGlzLl9jaGFubmVsRGVmZXJyZWQucmVzb2x2ZShAKVxuICBjYW5jZWw6IChjb25zdW1lclRhZykgLT5cbiAgICAjIE5vdCBjb25uZWN0ZWRcbiAgICBpZiBub3QgdGhpcy5jaGFubmVsXG4gICAgICByZXR1cm4gUS5yZWplY3QobmV3IEVycm9yKFwiTm90IGNvbm5lY3RlZFwiKSlcbiAgICB0aGlzLmNoYW5uZWwuY2FuY2VsKGNvbnN1bWVyVGFnKVxuICBjb25zdW1lOiAoY2FsbGJhY2ssIGNvbnRlbnRPbmx5LCBjb25zdW1lclRhZykgLT5cbiAgICBpZiBjYWxsYmFjayBub3QgaW5zdGFuY2VvZiBGdW5jdGlvblxuICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNhbGxiYWNrIGlzIGV4cGVjdGVkIHRvIGJlIGEgRnVuY3Rpb25cIilcbiAgICBpZiBub3QgY29uc3VtZXJUYWdcbiAgICAgICMgQ3JlYXRlIG9uZSBzbyB0aGV5IGNhbiBjYW5jZWwgaXRcbiAgICAgIGNvbnN1bWVyVGFnID0gdXVpZC52NCgpXG4gICAgY2xpZW50ID0gdGhpc1xuICAgIHRoaXMub24uY2hhbm5lbC50aGVuKC0+XG4gICAgICBjbGllbnQuY2hhbm5lbC5hc3NlcnRRdWV1ZShjbGllbnQua2V5KVxuICAgICAgY2xpZW50LmNoYW5uZWwuY29uc3VtZShjbGllbnQua2V5LCAobWVzc2FnZSkgLT5cbiAgICAgICAgIyBGaWx0ZXIgdGhlIGR1ZHMgaGVyZVxuICAgICAgICBpZiBtZXNzYWdlIGlzIG51bGwgb3IgbWVzc2FnZSBpcyB1bmRlZmluZWRcbiAgICAgICAgICByZXR1cm5cbiAgICAgICAgaWYgY29udGVudE9ubHlcbiAgICAgICAgICBtZXNzYWdlID0gbWVzc2FnZS5jb250ZW50XG4gICAgICAgICMgQ2hlY2sgYWdhaW5cbiAgICAgICAgaWYgbWVzc2FnZSBpcyBudWxsIG9yIG1lc3NhZ2UgaXMgdW5kZWZpbmVkXG4gICAgICAgICAgcmV0dXJuXG4gICAgICAgIGNhbGxiYWNrKG51bGwsIG1lc3NhZ2UpXG4gICAgICAsIGNvbnN1bWVyVGFnOiBjb25zdW1lclRhZylcbiAgICApXG4gICAgLmZhaWwoIChlcnIpIC0+XG4gICAgICBjYWxsYmFjayhlcnIsIG51bGwpXG4gICAgICByZXR1cm5cbiAgICApXG4gICAgY29uc3VtZXJUYWdcbiAgc2VuZDogKG1lc3NhZ2UpIC0+XG4gICAgaWYgbWVzc2FnZSBub3QgaW5zdGFuY2VvZiBCdWZmZXJcbiAgICAgIG1lc3NhZ2UgPSBuZXcgQnVmZmVyKG1lc3NhZ2UpXG4gICAgY2xpZW50ID0gdGhpc1xuICAgIHRoaXMub24uY2hhbm5lbC50aGVuKCAtPlxuICAgICAgY2xpZW50LmNoYW5uZWwuYXNzZXJ0UXVldWUoY2xpZW50LmtleSlcbiAgICAgIGNsaWVudC5jaGFubmVsLnNlbmRUb1F1ZXVlKGNsaWVudC5rZXksIG1lc3NhZ2UpXG4gICAgKVxubW9kdWxlLmV4cG9ydHMgPVxuICBnZXRDbGllbnQ6IChleGNoYW5nZSwga2V5KSAtPlxuICAgIHJldHVybiBuZXcgUmFiYml0TVFDbGllbnQoZXhjaGFuZ2UsIGtleSlcbiAgUmFiYml0TVFDbGllbnQ6IFJhYmJpdE1RQ2xpZW50Il19