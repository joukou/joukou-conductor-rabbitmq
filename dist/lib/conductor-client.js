var ConductorRabbitMQClient, JoukouConductorExchange, JoukouConductorRoutingKey, JoukouFleetAPIHost, JoukouFleetAPIPath, RabbitMQClient, fleet, httpClient, noflo, request,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

JoukouConductorExchange = process.env["JOUKOU_CONDUCTOR_EXCHANGE"];

JoukouConductorRoutingKey = process.env["JOUKOU_CONDUCTOR_ROUTING_KEY"];

JoukouFleetAPIHost = process.env["JOUKOU_FLEET_API_HOST"];

JoukouFleetAPIPath = process.env["JOUKOU_FLEET_API_PATH"];

RabbitMQClient = require('./client');

request = require('request');

fleet = require('joukou-conductor-fleet');

noflo = require('joukou-conductor-noflo').SystemD;

httpClient = require('./http-client');

if (!JoukouConductorExchange) {
  JoukouConductorExchange = "amqp://localhost";
  process.env["JOUKOU_CONDUCTOR_EXCHANGE"] = JoukouConductorExchange;
}

if (!JoukouConductorRoutingKey) {
  JoukouConductorRoutingKey = "CONDUCTOR";
  process.env["JOUKOU_CONDUCTOR_ROUTING_KEY"] = JoukouConductorRoutingKey;
}

if (!JoukouFleetAPIHost) {
  JoukouFleetAPIHost = "localhost:4002";
  process.env["JOUKOU_FLEET_API_HOST"] = JoukouFleetAPIHost;
}

if (!JoukouFleetAPIPath) {
  JoukouFleetAPIPath = "/v1/";
  process.env["JOUKOU_FLEET_API_PATH"] = JoukouFleetAPIPath;
}

ConductorRabbitMQClient = (function(_super) {
  __extends(ConductorRabbitMQClient, _super);

  ConductorRabbitMQClient.prototype.fleetClient = null;

  function ConductorRabbitMQClient() {
    var client;
    ConductorRabbitMQClient.__super__.constructor.call(this, JoukouConductorExchange, JoukouConductorRoutingKey);
    client = this;
    this.consume(function(err, message) {
      if (err) {
        throw err;
      }
      return client.onMessage.apply(client, [message]);
    }, true);
    this.fleetClient = fleet.getClient(JoukouFleetAPIHost, JoukouFleetAPIPath, true);
  }

  ConductorRabbitMQClient.prototype.onMessage = function(message) {
    if (!(message instanceof Object)) {
      return;
    }
    if (!(message["_links"] instanceof Object)) {
      return;
    }
    if (!(message["_links"]["joukou:graph"] instanceof Object)) {
      return;
    }
    if (!message["_links"]["joukou:graph"]["href"]) {
      return;
    }
    if (!message.desiredState) {
      return;
    }
    return this.onGraphHref(message["_links"]["joukou:graph"]["href"], message.desiredState, message.secret, message.exchange);
  };

  ConductorRabbitMQClient.prototype.onGraphHref = function(graphHref, desiredState, secret, exchange) {
    var client, createExchangePromise, graph, graphDeferred, options;
    options = null;
    if (secret) {
      options = {
        auth: {
          bearer: secret
        }
      };
    }
    client = this;
    graphDeferred = Q.defer();
    graph = null;
    request.get(graphHref, options, function(error, response, body, desiredState) {
      return graph = client.onGraphResponse.apply(client, [error, response, body, desiredState, graphDeferred]);
    });
    createExchangePromise = httpClient.createExchange(exchange, null, 'direct', true, true);
    return Q.all([graphDeferred.promise, createExchangePromise]).then(function() {
      return createUnit(graph, exchange);
    });
  };

  ConductorRabbitMQClient.prototype.createUnit = function(body, exchange) {

    /*
      unitName: "name"
      options: [SystemDUnitFile].options
      machineID: machineID
     */
    var client;
    noflo.createFromSchema(body, null, "TODO", "TODO", exchange);
    client = this.fleetClient;
    return client.createUnit(options.unitName, options.options, null, options.machineID);
  };

  ConductorRabbitMQClient.prototype.onGraphResponse = function(error, response, body, graphDeferred) {
    var jsonBody;
    if (error || response.statusCode !== 200) {
      graphDeferred.reject();
      return;
    }
    jsonBody = null;
    try {
      jsonBody = JSON.parse(body);
    } catch (_error) {}
    if (!jsonBody) {
      graphDeferred.reject();
      return;
    }
    try {
      graphDeferred.resolve();
      return jsonBody;
    } catch (_error) {
      return graphDeferred.reject();
    }
  };

  return ConductorRabbitMQClient;

})(RabbitMQClient);

module.exports = {
  listen: function() {
    return new ConductorRabbitMQClient();
  },
  ConductorRabbitMQClient: ConductorRabbitMQClient
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb25kdWN0b3ItY2xpZW50LmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxJQUFBLHNLQUFBO0VBQUE7aVNBQUE7O0FBQUEsdUJBQUEsR0FBNEIsT0FBTyxDQUFDLEdBQUksQ0FBQSwyQkFBQSxDQUF4QyxDQUFBOztBQUFBLHlCQUNBLEdBQTRCLE9BQU8sQ0FBQyxHQUFJLENBQUEsOEJBQUEsQ0FEeEMsQ0FBQTs7QUFBQSxrQkFHQSxHQUE0QixPQUFPLENBQUMsR0FBSSxDQUFBLHVCQUFBLENBSHhDLENBQUE7O0FBQUEsa0JBSUEsR0FBNEIsT0FBTyxDQUFDLEdBQUksQ0FBQSx1QkFBQSxDQUp4QyxDQUFBOztBQUFBLGNBTUEsR0FBNEIsT0FBQSxDQUFRLFVBQVIsQ0FONUIsQ0FBQTs7QUFBQSxPQU9BLEdBQTRCLE9BQUEsQ0FBUSxTQUFSLENBUDVCLENBQUE7O0FBQUEsS0FRQSxHQUE0QixPQUFBLENBQVEsd0JBQVIsQ0FSNUIsQ0FBQTs7QUFBQSxLQVNBLEdBQTRCLE9BQUEsQ0FBUSx3QkFBUixDQUFpQyxDQUFDLE9BVDlELENBQUE7O0FBQUEsVUFVQSxHQUE0QixPQUFBLENBQVEsZUFBUixDQVY1QixDQUFBOztBQWNBLElBQUcsQ0FBQSx1QkFBSDtBQUNFLEVBQUEsdUJBQUEsR0FBMEIsa0JBQTFCLENBQUE7QUFBQSxFQUNBLE9BQU8sQ0FBQyxHQUFJLENBQUEsMkJBQUEsQ0FBWixHQUEyQyx1QkFEM0MsQ0FERjtDQWRBOztBQWtCQSxJQUFHLENBQUEseUJBQUg7QUFDRSxFQUFBLHlCQUFBLEdBQTRCLFdBQTVCLENBQUE7QUFBQSxFQUNBLE9BQU8sQ0FBQyxHQUFJLENBQUEsOEJBQUEsQ0FBWixHQUE4Qyx5QkFEOUMsQ0FERjtDQWxCQTs7QUFzQkEsSUFBRyxDQUFBLGtCQUFIO0FBQ0UsRUFBQSxrQkFBQSxHQUFxQixnQkFBckIsQ0FBQTtBQUFBLEVBQ0EsT0FBTyxDQUFDLEdBQUksQ0FBQSx1QkFBQSxDQUFaLEdBQXVDLGtC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QUFIO0FBQ0UsTUFBQSxhQUFhLENBQUMsTUFBZCxDQUFBLENBQUEsQ0FBQTtBQUNBLFlBQUEsQ0FGRjtLQU5BO0FBU0E7QUFDRSxNQUFBLGFBQWEsQ0FBQyxPQUFkLENBQUEsQ0FBQSxDQUFBO0FBQ0EsYUFBTyxRQUFQLENBRkY7S0FBQSxjQUFBO2FBSUUsYUFBYSxDQUFDLE1BQWQsQ0FBQSxFQUpGO0tBVmU7RUFBQSxDQXpHakIsQ0FBQTs7aUNBQUE7O0dBRG9DLGVBOUJ0QyxDQUFBOztBQUFBLE1BdUpNLENBQUMsT0FBUCxHQUNFO0FBQUEsRUFBQSxNQUFBLEVBQVEsU0FBQSxHQUFBO1dBQ0YsSUFBQSx1QkFBQSxDQUFBLEVBREU7RUFBQSxDQUFSO0FBQUEsRUFFQSx1QkFBQSxFQUF5Qix1QkFGekI7Q0F4SkYsQ0FBQSIsImZpbGUiOiJsaWIvY29uZHVjdG9yLWNsaWVudC5qcyIsInNvdXJjZVJvb3QiOiIvc291cmNlLyIsInNvdXJjZXNDb250ZW50IjpbIkpvdWtvdUNvbmR1Y3RvckV4Y2hhbmdlICAgPSBwcm9jZXNzLmVudltcIkpPVUtPVV9DT05EVUNUT1JfRVhDSEFOR0VcIl1cbkpvdWtvdUNvbmR1Y3RvclJvdXRpbmdLZXkgPSBwcm9jZXNzLmVudltcIkpPVUtPVV9DT05EVUNUT1JfUk9VVElOR19LRVlcIl1cblxuSm91a291RmxlZXRBUElIb3N0ICAgICAgICA9IHByb2Nlc3MuZW52W1wiSk9VS09VX0ZMRUVUX0FQSV9IT1NUXCJdXG5Kb3Vrb3VGbGVldEFQSVBhdGggICAgICAgID0gcHJvY2Vzcy5lbnZbXCJKT1VLT1VfRkxFRVRfQVBJX1BBVEhcIl1cblxuUmFiYml0TVFDbGllbnQgICAgICAgICAgICA9IHJlcXVpcmUoJy4vY2xpZW50JylcbnJlcXVlc3QgICAgICAgICAgICAgICAgICAgPSByZXF1aXJlKCdyZXF1ZXN0JylcbmZsZWV0ICAgICAgICAgICAgICAgICAgICAgPSByZXF1aXJlKCdqb3Vrb3UtY29uZHVjdG9yLWZsZWV0Jylcbm5vZmxvICAgICAgICAgICAgICAgICAgICAgPSByZXF1aXJlKCdqb3Vrb3UtY29uZHVjdG9yLW5vZmxvJykuU3lzdGVtRFxuaHR0cENsaWVudCAgICAgICAgICAgICAgICA9IHJlcXVpcmUoJy4vaHR0cC1jbGllbnQnKVxuXG4jIFNldCB0aGUgRU5WIHZhcmlhYmxlIGZvciBuZXh0IHRpbWVcbiMgVGhpcyBkb2VzIG5vdCBlZmZlY3QgZ2xvYmFsIGVudiBqdXN0IHRoaXMgcHJvY2Vzc1xuaWYgbm90IEpvdWtvdUNvbmR1Y3RvckV4Y2hhbmdlXG4gIEpvdWtvdUNvbmR1Y3RvckV4Y2hhbmdlID0gXCJhbXFwOi8vbG9jYWxob3N0XCJcbiAgcHJvY2Vzcy5lbnZbXCJKT1VLT1VfQ09ORFVDVE9SX0VYQ0hBTkdFXCJdID0gSm91a291Q29uZHVjdG9yRXhjaGFuZ2VcblxuaWYgbm90IEpvdWtvdUNvbmR1Y3RvclJvdXRpbmdLZXlcbiAgSm91a291Q29uZHVjdG9yUm91dGluZ0tleSA9IFwiQ09ORFVDVE9SXCJcbiAgcHJvY2Vzcy5lbnZbXCJKT1VLT1VfQ09ORFVDVE9SX1JPVVRJTkdfS0VZXCJdID0gSm91a291Q29uZHVjdG9yUm91dGluZ0tleVxuXG5pZiBub3QgSm91a291RmxlZXRBUElIb3N0XG4gIEpvdWtvdUZsZWV0QVBJSG9zdCA9IFwibG9jYWxob3N0OjQwMDJcIlxuICBwcm9jZXNzLmVudltcIkpPVUtPVV9GTEVFVF9BUElfSE9TVFwiXSA9IEpvdWtvdUZsZWV0QVBJSG9zdFxuXG5pZiBub3QgSm91a291RmxlZXRBUElQYXRoXG4gIEpvdWtvdUZsZWV0QVBJUGF0aCA9IFwiL3YxL1wiXG4gIHByb2Nlc3MuZW52W1wiSk9VS09VX0ZMRUVUX0FQSV9QQVRIXCJdID0gSm91a291RmxlZXRBUElQYXRoXG5cbmNsYXNzIENvbmR1Y3RvclJhYmJpdE1RQ2xpZW50IGV4dGVuZHMgUmFiYml0TVFDbGllbnRcbiAgZmxlZXRDbGllbnQ6IG51bGxcbiAgY29uc3RydWN0b3I6IC0+XG4gICAgc3VwZXIoSm91a291Q29uZHVjdG9yRXhjaGFuZ2UsIEpvdWtvdUNvbmR1Y3RvclJvdXRpbmdLZXkpXG4gICAgY2xpZW50ID0gdGhpc1xuICAgIHRoaXMuY29uc3VtZSggKGVyciwgbWVzc2FnZSkgLT5cbiAgICAgIGlmIGVyclxuICAgICAgICB0aHJvdyBlcnJcbiAgICAgIGNsaWVudC5vbk1lc3NhZ2UuYXBwbHkoY2xpZW50LCBbbWVzc2FnZV0pXG4gICAgLCB5ZXMpXG4gICAgdGhpcy5mbGVldENsaWVudCA9IGZsZWV0LmdldENsaWVudChcbiAgICAgIEpvdWtvdUZsZWV0QVBJSG9zdCxcbiAgICAgIEpvdWtvdUZsZWV0QVBJUGF0aCxcbiAgICAgIHllc1xuICAgIClcbiAgb25NZXNzYWdlOiAobWVzc2FnZSkgLT5cbiAgICAjIHRoaXMgc2hvdWxkIHN0b3AgdGhlIHByb2Nlc3NcbiAgICAjIEhlcmUgd2UgbXVzdCBwcm9jZXNzIHdoYXQgdGhlIHBlZXBzXG4gICAgIyB3YW50IHRoZWlyIGdyYXBocyB0byBkb1xuICAgICMgSGVyZSBpcyBhbiBleGFtcGxlIG9mIG1lc3NhZ2VzIGZyb20gSXNhYWM6XG4gICAgIyB7XG4gICAgIyAgXCJfbGlua3NcIjoge1xuICAgICMgICAgXCJqb3Vrb3U6Z3JhcGhcIjoge1xuICAgICMgICAgICBcImhyZWZcIjpcbiAgICAjICAgICAgICAgXCJodHRwOi8vYXBpLmpvdWtvdS5sb2NhbDoyMTAxL3BlcnNvbmEvcGVyc29uYVV1aWQvZ3JhcGgvZ3JhcGhVdWlkXCJcbiAgICAjICAgIH1cbiAgICAjICB9LFxuICAgICMgIFwiZGVzaXJlZFN0YXRlXCI6IFwibGF1bmNoZWRcIiwgLy8gb3IgXCJpbmFjdGl2ZVwiXG4gICAgIyAgXCJzZWNyZXRcIjogXCJqc29uLXdlYi10b2tlblwiLFxuICAgICMgIC8vIEFkZGl0aW9uYWwgLSBGYWJpYW5cbiAgICAjICBcImV4Y2hhbmdlXCI6IFwiZXhjaGFuZ2VcIlxuICAgICN9XG4gICAgIyBObyBvbmUgaXMgbGlzdGVuaW5nIGZvciBlcnJvcnMgc28ganVzdCByZXR1cm5cbiAgICAjIGlmIHRoZXJlIGlzIHNvbWV0aGluZyBtaXNzaW5nXG4gICAgaWYgbWVzc2FnZSBub3QgaW5zdGFuY2VvZiBPYmplY3RcbiAgICAgIHJldHVyblxuICAgIGlmIG1lc3NhZ2VbXCJfbGlua3NcIl0gbm90IGluc3RhbmNlb2YgT2JqZWN0XG4gICAgICByZXR1cm5cbiAgICBpZiBtZXNzYWdlW1wiX2xpbmtzXCJdW1wiam91a291OmdyYXBoXCJdIG5vdCBpbnN0YW5jZW9mIE9iamVjdFxuICAgICAgcmV0dXJuXG4gICAgaWYgbm90IG1lc3NhZ2VbXCJfbGlua3NcIl1bXCJqb3Vrb3U6Z3JhcGhcIl1bXCJocmVmXCJdXG4gICAgICByZXR1cm5cbiAgICBpZiBub3QgbWVzc2FnZS5kZXNpcmVkU3RhdGVcbiAgICAgIHJldHVyblxuICAgICNNYXkgYmUgYSBwdWJsaWMgZ3JhcGgsIHdlIHdpbGwgdHJ5IHdpdGhvdXQgdGhpc1xuICAgICNpZiBub3QgbWVzc2FnZS5zZWNyZXRcbiAgICAjICByZXR1cm5cbiAgICB0aGlzLm9uR3JhcGhIcmVmKFxuICAgICAgbWVzc2FnZVtcIl9saW5rc1wiXVtcImpvdWtvdTpncmFwaFwiXVtcImhyZWZcIl0sXG4gICAgICBtZXNzYWdlLmRlc2lyZWRTdGF0ZSxcbiAgICAgIG1lc3NhZ2Uuc2VjcmV0LFxuICAgICAgbWVzc2FnZS5leGNoYW5nZVxuICAgIClcbiAgb25HcmFwaEhyZWY6IChncmFwaEhyZWYsIGRlc2lyZWRTdGF0ZSwgc2VjcmV0LCBleGNoYW5nZSkgLT5cbiAgICBvcHRpb25zID0gbnVsbFxuICAgIGlmIHNlY3JldFxuICAgICAgb3B0aW9ucyA9XG4gICAgICAgIGF1dGg6XG4gICAgICAgICAgIyBodHRwczovL2dpdGh1Yi5jb20vcmVxdWVzdC9yZXF1ZXN0I2h0dHAtYXV0aGVudGljYXRpb25cbiAgICAgICAgICBiZWFyZXI6IHNlY3JldFxuICAgIGNsaWVudCA9IHRoaXNcbiAgICBncmFwaERlZmVycmVkID0gUS5kZWZlcigpXG4gICAgZ3JhcGggPSBudWxsXG4gICAgcmVxdWVzdC5nZXQoZ3JhcGhIcmVmLCBvcHRpb25zLCAoZXJyb3IsIHJlc3BvbnNlLCBib2R5LCBkZXNpcmVkU3RhdGUpIC0+XG4gICAgICBncmFwaCA9IGNsaWVudC5vbkdyYXBoUmVzcG9uc2UuYXBwbHkoY2xpZW50LCBbXG4gICAgICAgIGVycm9yLFxuICAgICAgICByZXNwb25zZSxcbiAgICAgICAgYm9keSxcbiAgICAgICAgZGVzaXJlZFN0YXRlLFxuICAgICAgICBncmFwaERlZmVycmVkXG4gICAgICBdKVxuICAgIClcbiAgICAjIEF0IHRoZSBzYW1lIHRpbWUgd2Ugc2hvdWxkIGJlIGNyZWF0aW5nIHRoZSBleGNoYW5nZVxuICAgIGNyZWF0ZUV4Y2hhbmdlUHJvbWlzZSA9IGh0dHBDbGllbnQuY3JlYXRlRXhjaGFuZ2UoXG4gICAgICBleGNoYW5nZSxcbiAgICAgIG51bGwsICMgRGVmYXVsdFxuICAgICAgJ2RpcmVjdCcsXG4gICAgICB5ZXMsXG4gICAgICB5ZXNcbiAgICApXG4gICAgUS5hbGwoW1xuICAgICAgZ3JhcGhEZWZlcnJlZC5wcm9taXNlLFxuICAgICAgY3JlYXRlRXhjaGFuZ2VQcm9taXNlXG4gICAgXSkudGhlbigtPlxuICAgICAgY3JlYXRlVW5pdChncmFwaCwgZXhjaGFuZ2UpXG4gICAgKVxuICBjcmVhdGVVbml0OiAoYm9keSwgZXhjaGFuZ2UpIC0+XG4gICAgIyMjXG4gICAgICB1bml0TmFtZTogXCJuYW1lXCJcbiAgICAgIG9wdGlvbnM6IFtTeXN0ZW1EVW5pdEZpbGVdLm9wdGlvbnNcbiAgICAgIG1hY2hpbmVJRDogbWFjaGluZUlEXG4gICAgIyMjXG4gICAgbm9mbG8uY3JlYXRlRnJvbVNjaGVtYShcbiAgICAgIGJvZHksXG4gICAgICBudWxsLCAjIFRPRE8gbWFjaGluZUlEXG4gICAgICBcIlRPRE9cIiwgIyBUT0RPIGpvdWtvdU1lc3NhZ2VRdWVBZGRyZXNzIEVOVlxuICAgICAgXCJUT0RPXCIsICMgVE9ETyBqb3Vrb3VBcGlBZGRyZXNzIEVOVlxuICAgICAgZXhjaGFuZ2VcbiAgICApXG4gICAgY2xpZW50ID0gdGhpcy5mbGVldENsaWVudFxuICAgIGNsaWVudC5jcmVhdGVVbml0KFxuICAgICAgb3B0aW9ucy51bml0TmFtZSxcbiAgICAgIG9wdGlvbnMub3B0aW9ucyxcbiAgICAgIG51bGwsXG4gICAgICBvcHRpb25zLm1hY2hpbmVJRFxuICAgIClcbiAgb25HcmFwaFJlc3BvbnNlOiAoZXJyb3IsIHJlc3BvbnNlLCBib2R5LCBncmFwaERlZmVycmVkKSAtPlxuICAgIGlmIGVycm9yIG9yIHJlc3BvbnNlLnN0YXR1c0NvZGUgaXNudCAyMDBcbiAgICAgIGdyYXBoRGVmZXJyZWQucmVqZWN0KClcbiAgICAgIHJldHVyblxuICAgIGpzb25Cb2R5ID0gbnVsbFxuICAgIHRyeVxuICAgICAganNvbkJvZHkgPSBKU09OLnBhcnNlKGJvZHkpXG4gICAgaWYgbm90IGpzb25Cb2R5XG4gICAgICBncmFwaERlZmVycmVkLnJlamVjdCgpXG4gICAgICByZXR1cm5cbiAgICB0cnlcbiAgICAgIGdyYXBoRGVmZXJyZWQucmVzb2x2ZSgpXG4gICAgICByZXR1cm4ganNvbkJvZHlcbiAgICBjYXRjaFxuICAgICAgZ3JhcGhEZWZlcnJlZC5yZWplY3QoKVxubW9kdWxlLmV4cG9ydHMgPVxuICBsaXN0ZW46IC0+XG4gICAgbmV3IENvbmR1Y3RvclJhYmJpdE1RQ2xpZW50KClcbiAgQ29uZHVjdG9yUmFiYml0TVFDbGllbnQ6IENvbmR1Y3RvclJhYmJpdE1RQ2xpZW50XG4iXX0=